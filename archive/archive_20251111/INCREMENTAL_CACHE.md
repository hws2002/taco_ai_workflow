# ì¦ë¶„ ìºì‹± (Incremental Caching) ê°€ì´ë“œ

ë©”ì‹œì§€ ID ê¸°ë°˜ì˜ ìŠ¤ë§ˆíŠ¸ ìºì‹± ì‹œìŠ¤í…œìœ¼ë¡œ, ìƒˆë¡œìš´ ë°ì´í„° ì¶”ê°€ ì‹œ ê¸°ì¡´ ê³„ì‚°ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤.

## ğŸ¯ ê¸°ì¡´ ë°©ì‹ vs ì¦ë¶„ ìºì‹±

### ê¸°ì¡´ ë°©ì‹ (ì „ì²´ ì €ì¥/ë¡œë“œ)
```
ì²« ì‹¤í–‰: 50ê°œ ëŒ€í™” â†’ 820ê°œ ì„ë² ë”© ê³„ì‚° â†’ ì „ì²´ ì €ì¥
ë°ì´í„° ì¶”ê°€: 51ê°œ ëŒ€í™” â†’ âŒ 821ê°œ ëª¨ë‘ ë‹¤ì‹œ ê³„ì‚°
```
**ë¬¸ì œì **: 1ê°œë§Œ ì¶”ê°€í•´ë„ ëª¨ë“  ê²ƒì„ ë‹¤ì‹œ ê³„ì‚°!

### ì¦ë¶„ ìºì‹± (ID ê¸°ë°˜)
```
ì²« ì‹¤í–‰: 50ê°œ ëŒ€í™” â†’ 820ê°œ ì„ë² ë”© ê³„ì‚° â†’ IDë³„ë¡œ ì €ì¥
ë°ì´í„° ì¶”ê°€: 51ê°œ ëŒ€í™” â†’ âœ… ìƒˆë¡œìš´ 1ê°œë§Œ ê³„ì‚° (820ê°œëŠ” ì¬ì‚¬ìš©)
```
**ì¥ì **: ìƒˆë¡œ ì¶”ê°€ëœ ê²ƒë§Œ ê³„ì‚°!

## ğŸ“¦ ì‘ë™ ì›ë¦¬

### 1. ì„ë² ë”© ìºì‹œ êµ¬ì¡°
```python
{
    "1_0": {  # response_id (ëŒ€í™”ID_ë©”ì‹œì§€ì¸ë±ìŠ¤)
        "embedding": np.array([...]),  # 1024ì°¨ì› ë²¡í„°
        "concepts": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2"],
        "conversation_id": 1,
        ...
    },
    "1_1": {...},
    "2_0": {...},
    ...
}
```

### 2. ìºì‹œ í™•ì¸ ê³¼ì •
```python
# 1. í˜„ì¬ í•„ìš”í•œ ëª¨ë“  ì‘ë‹µ ID
all_ids = ["1_0", "1_1", "2_0", ..., "50_10"]

# 2. ìºì‹œì— ìˆëŠ” ID í™•ì¸
cached_ids = ["1_0", "1_1", ..., "49_8"]  # 790ê°œ

# 3. ì—†ëŠ” ê²ƒë§Œ ì°¾ê¸°
missing_ids = all_ids - cached_ids  # ["50_0", ..., "50_10"]  # 30ê°œ

# 4. ì—†ëŠ” ê²ƒë§Œ ê³„ì‚°
# 30ê°œë§Œ ìƒˆë¡œ ê³„ì‚° (790ê°œëŠ” ì¬ì‚¬ìš©)
```

### 3. ìœ ì‚¬ë„ ìºì‹œ êµ¬ì¡°
```python
{
    (1, 2): 0.85,  # ëŒ€í™” 1ê³¼ 2ì˜ ìœ ì‚¬ë„
    (1, 3): 0.72,
    (2, 3): 0.91,
    ...
}
```

ìƒˆ ëŒ€í™” ì¶”ê°€ ì‹œ:
```python
# ëŒ€í™” 51ì´ ì¶”ê°€ë˜ë©´
# í•„ìš”í•œ ìŒ: (1,51), (2,51), ..., (50,51)  # 50ê°œë§Œ ìƒˆë¡œ ê³„ì‚°
# ê¸°ì¡´ ìŒ: (1,2), (1,3), ..., (49,50)  # ì¬ì‚¬ìš©
```

## ğŸš€ ì‚¬ìš© ë°©ë²•

### ê¸°ë³¸ ì‚¬ìš© (ì¦ë¶„ ìºì‹± í™œì„±í™”)
```bash
# ì¦ë¶„ ìºì‹±ì€ ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™”ë¨
python -X utf8 test/test_embedding_workflow.py --use-cache
```

### ì „ì²´ ì €ì¥/ë¡œë“œ ë°©ì‹ ì‚¬ìš©
```bash
# ì¦ë¶„ ìºì‹± ë¹„í™œì„±í™”
python -X utf8 test/test_embedding_workflow.py --use-cache --no-incremental
```

## ğŸ“Š ì‹¤ì „ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì ì§„ì  ë°ì´í„° ì¶”ê°€

**1ë‹¨ê³„: ì´ˆê¸° ì‹¤í–‰ (50ê°œ ëŒ€í™”)**
```bash
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 50
```
```
ì „ì²´ ì‘ë‹µ: 820ê°œ
ìºì‹œì— ìˆìŒ: 0ê°œ
ìƒˆë¡œ ê³„ì‚° í•„ìš”: 820ê°œ

820ê°œì˜ ìƒˆë¡œìš´ ì„ë² ë”© ê³„ì‚° ì¤‘...
âœ“ 820ê°œì˜ ìƒˆë¡œìš´ ì„ë² ë”© ì¶”ê°€
â±ï¸  ì†Œìš” ì‹œê°„: 3ë¶„ 25ì´ˆ
```

**2ë‹¨ê³„: ë°ì´í„° ì¶”ê°€ (100ê°œë¡œ í™•ì¥)**
```bash
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 100
```
```
ì „ì²´ ì‘ë‹µ: 1640ê°œ
ìºì‹œì— ìˆìŒ: 820ê°œ
ìƒˆë¡œ ê³„ì‚° í•„ìš”: 820ê°œ

820ê°œì˜ ìƒˆë¡œìš´ ì„ë² ë”© ê³„ì‚° ì¤‘...
âœ“ 820ê°œì˜ ìƒˆë¡œìš´ ì„ë² ë”© ì¶”ê°€
â±ï¸  ì†Œìš” ì‹œê°„: 3ë¶„ 30ì´ˆ  (ê¸°ì¡´ 820ê°œëŠ” 0ì´ˆ!)
```

**3ë‹¨ê³„: ë‹¤ì‹œ 50ê°œë¡œ í…ŒìŠ¤íŠ¸**
```bash
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 50
```
```
ì „ì²´ ì‘ë‹µ: 820ê°œ
ìºì‹œì— ìˆìŒ: 820ê°œ
ìƒˆë¡œ ê³„ì‚° í•„ìš”: 0ê°œ

âœ“ ëª¨ë“  ì„ë² ë”©ì´ ìºì‹œì— ìˆìŒ (ê³„ì‚° ê±´ë„ˆëœ€)
â±ï¸  ì†Œìš” ì‹œê°„: 2.5ì´ˆ  (ë¡œë“œë§Œ)
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ìƒˆë¡œìš´ ëŒ€í™” ì¶”ê°€

```bash
# 1. ì²˜ìŒ 376ê°œ ì „ì²´ ì‹¤í–‰
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 376
# ì„ë² ë”©: ~6200ê°œ ê³„ì‚° (ì•½ 25ë¶„)

# 2. ë°ì´í„°ì— ìƒˆ ëŒ€í™” 10ê°œ ì¶”ê°€ (ì´ 386ê°œ)

# 3. ë‹¤ì‹œ ì‹¤í–‰
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 386
# ì„ë² ë”©: ~160ê°œë§Œ ê³„ì‚° (ì•½ 40ì´ˆ)
# ê¸°ì¡´ 6200ê°œëŠ” ì¬ì‚¬ìš©!
```

## ğŸ“ˆ ì„±ëŠ¥ ë¹„êµ

### ë°ì´í„° ì¶”ê°€ ì‹œ (50ê°œ â†’ 100ê°œ)

| ë°©ì‹ | ì²« ì‹¤í–‰ (50ê°œ) | ì¶”ê°€ ì‹¤í–‰ (100ê°œ) | ì´ ì‹œê°„ |
|------|---------------|------------------|---------|
| **ì „ì²´ ì €ì¥/ë¡œë“œ** | 5ë¶„ | 10ë¶„ | **15ë¶„** |
| **ì¦ë¶„ ìºì‹±** | 5ë¶„ | 5ë¶„ | **10ë¶„** (33% ì ˆì•½) |

### ë°˜ë³µ í…ŒìŠ¤íŠ¸ ì‹œ (ê°™ì€ 50ê°œ)

| ë°©ì‹ | ì²« ì‹¤í–‰ | 2ë²ˆì§¸ | 3ë²ˆì§¸ |
|------|---------|-------|-------|
| **ì „ì²´ ì €ì¥/ë¡œë“œ** | 5ë¶„ | 10ì´ˆ | 10ì´ˆ |
| **ì¦ë¶„ ìºì‹±** | 5ë¶„ | 3ì´ˆ | 3ì´ˆ |

*ì¦ë¶„ ìºì‹±ì´ ë¡œë“œë„ ë” ë¹ ë¦„ (í•„ìš”í•œ ê²ƒë§Œ ë¡œë“œ)*

## ğŸ” ìºì‹œ ì •ë³´ í™•ì¸

### ìºì‹œ ìƒíƒœ í™•ì¸
```bash
python -X utf8 test/test_embedding_workflow.py --use-cache
```
ì¶œë ¥:
```
================================================================================
ìºì‹œ ì •ë³´
================================================================================
ì„ë² ë”© ìºì‹œ: 820ê°œ
ìœ ì‚¬ë„ ìºì‹œ: 1225ê°œ ìŒ
í´ëŸ¬ìŠ¤í„°ë§ ìºì‹œ: 820ê°œ

ë©”íƒ€ë°ì´í„°:
  last_update: 2025-11-02T17:30:45.123456
  total_responses: 820
  total_conversations: 50
================================================================================
```

### ì ì¤‘ë¥  í™•ì¸
ì½”ë“œì—ì„œ:
```python
from analyze.incremental_cache import IncrementalCache

cache = IncrementalCache()

# ì„ë² ë”© ìºì‹œ ì ì¤‘ë¥ 
hit_rate = cache.get_embedding_hit_rate(all_response_ids)
print(f"ì„ë² ë”© ìºì‹œ ì ì¤‘ë¥ : {hit_rate * 100:.1f}%")

# ìœ ì‚¬ë„ ìºì‹œ ì ì¤‘ë¥ 
hit_rate = cache.get_similarity_hit_rate(all_conv_ids)
print(f"ìœ ì‚¬ë„ ìºì‹œ ì ì¤‘ë¥ : {hit_rate * 100:.1f}%")
```

## ğŸ’¾ ìºì‹œ íŒŒì¼ êµ¬ì¡°

```
cache/
â”œâ”€â”€ embeddings_by_id.pkl       # ì„ë² ë”© ìºì‹œ (ID â†’ ë²¡í„°)
â”œâ”€â”€ similarities_by_id.pkl     # ìœ ì‚¬ë„ ìºì‹œ (ID ìŒ â†’ ìœ ì‚¬ë„)
â”œâ”€â”€ clustering_by_id.pkl       # í´ëŸ¬ìŠ¤í„°ë§ ê²°ê³¼ (ID â†’ í† í”½ ID)
â””â”€â”€ cache_metadata.json        # ë©”íƒ€ë°ì´í„°
```

### íŒŒì¼ í¬ê¸° ì˜ˆì¸¡

| ë°ì´í„° í¬ê¸° | ì„ë² ë”© ìºì‹œ | ìœ ì‚¬ë„ ìºì‹œ | ì´ í¬ê¸° |
|------------|------------|------------|---------|
| 50ê°œ ëŒ€í™” (~820ê°œ ë‹µë³€) | 25 MB | 5 MB | ~30 MB |
| 100ê°œ ëŒ€í™” (~1640ê°œ ë‹µë³€) | 50 MB | 20 MB | ~70 MB |
| 376ê°œ ëŒ€í™” (~6200ê°œ ë‹µë³€) | 190 MB | 280 MB | ~470 MB |

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ë°ì´í„° ë³€ê²½ ì‹œ

**ì„ë² ë”© ëª¨ë¸ ë³€ê²½**
```bash
# ëª¨ë¸ì„ BAAI/bge-m3 â†’ jhgan/ko-sroberta-multitaskë¡œ ë³€ê²½í•œ ê²½ìš°
# ìºì‹œ ì´ˆê¸°í™” í•„ìš” (ì°¨ì›ì´ ë‹¬ë¼ì§)
python -X utf8 test/test_embedding_workflow.py --use-cache --clear-cache
```

**ë©”ì‹œì§€ ë‚´ìš© ìˆ˜ì •**
```
# ë©”ì‹œì§€ IDëŠ” ê°™ì§€ë§Œ ë‚´ìš©ì´ ë°”ë€ ê²½ìš°
# â†’ ìºì‹œê°€ ì˜¤ë˜ëœ ë‚´ìš©ì„ ì‚¬ìš©í•¨ (ì£¼ì˜!)
# â†’ í•´ë‹¹ ë©”ì‹œì§€ì˜ ìºì‹œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ê±°ë‚˜ ì „ì²´ ì´ˆê¸°í™”
```

### 2. ìºì‹œ ì¼ê´€ì„±

```python
# ë©”ì‹œì§€ ì‚­ì œ ì‹œ
# ìºì‹œì—ëŠ” ë‚¨ì•„ìˆì§€ë§Œ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ (ë¬¸ì œì—†ìŒ)

# ë©”ì‹œì§€ ID ì¶©ëŒ
# ê°™ì€ IDë¡œ ë‹¤ë¥¸ ë©”ì‹œì§€ â†’ ì˜¤ë˜ëœ ê²ƒ ì‚¬ìš©ë¨ (ì£¼ì˜!)
# â†’ ID ìƒì„± ì‹œ ì¶©ëŒ ë°©ì§€ í•„ìš”
```

### 3. ë””ìŠ¤í¬ ê³µê°„

```bash
# ìºì‹œ í¬ê¸° í™•ì¸
python
>>> from analyze.incremental_cache import IncrementalCache
>>> cache = IncrementalCache()
>>> sizes = cache.estimate_cache_size()
>>> print(f"ì´ ìºì‹œ í¬ê¸°: {sizes['total']:.1f} MB")
```

## ğŸ› ï¸ í”„ë¡œê·¸ë˜ë° ë°©ì‹ ì‚¬ìš©

### ê¸°ë³¸ ì‚¬ìš©
```python
from analyze.incremental_cache import IncrementalCache

cache = IncrementalCache(cache_dir="cache")

# 1. ìºì‹œ ë¡œë“œ
embeddings_cache = cache.load_embeddings_cache()

# 2. ì—†ëŠ” ê²ƒ ì°¾ê¸°
all_ids = ["1_0", "1_1", "2_0", ...]
missing_ids = cache.get_missing_embeddings(all_ids, embeddings_cache)

# 3. ì—†ëŠ” ê²ƒë§Œ ê³„ì‚°
new_embeddings = calculate_embeddings(missing_ids)

# 4. ìºì‹œ ì—…ë°ì´íŠ¸
embeddings_cache = cache.update_embeddings_cache(embeddings_cache, new_embeddings)

# 5. ì €ì¥
cache.save_embeddings_cache(embeddings_cache)
```

### ìœ ì‚¬ë„ ìºì‹œ
```python
# 1. ìºì‹œ ë¡œë“œ
similarities_cache = cache.load_similarities_cache()

# 2. ì—†ëŠ” ìŒ ì°¾ê¸°
all_conv_ids = [1, 2, 3, ..., 50]
missing_pairs = cache.get_missing_similarities(all_conv_ids, similarities_cache)

# 3. ì—†ëŠ” ê²ƒë§Œ ê³„ì‚°
new_similarities = {
    (1, 51): 0.85,
    (2, 51): 0.72,
    ...
}

# 4. ìºì‹œ ì—…ë°ì´íŠ¸ ë° ì €ì¥
similarities_cache = cache.update_similarities_cache(similarities_cache, new_similarities)
cache.save_similarities_cache(similarities_cache)
```

## ğŸ¯ ê¶Œì¥ ì›Œí¬í”Œë¡œìš°

### ê°œë°œ ë‹¨ê³„
```bash
# ì‘ì€ ìƒ˜í”Œë¡œ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 10
```

### ì¦ë¶„ ì¶”ê°€
```bash
# 10 â†’ 20 â†’ 50 â†’ 100 â†’ 376 ìˆœì„œë¡œ ì ì§„ì  í™•ì¥
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 20
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 50
# ê° ë‹¨ê³„ì—ì„œ ìƒˆë¡œìš´ ê²ƒë§Œ ê³„ì‚°
```

### ìµœì¢… ì‹¤í–‰
```bash
# ì „ì²´ ë°ì´í„°
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 376
# ì´ì „ ë‹¨ê³„ì˜ ëª¨ë“  ìºì‹œ ì¬ì‚¬ìš©
```

## ğŸ’¡ ì¥ì  ìš”ì•½

1. **ë°ì´í„° ì¶”ê°€ ì‹œ íš¨ìœ¨ì ** - ìƒˆë¡œìš´ ê²ƒë§Œ ê³„ì‚°
2. **ë©”ëª¨ë¦¬ íš¨ìœ¨ì ** - í•„ìš”í•œ ê²ƒë§Œ ë¡œë“œ
3. **ë¶€ë¶„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥** - ì „ì²´ ì¬ê³„ì‚° ë¶ˆí•„ìš”
4. **ë””ë²„ê¹… ìš©ì´** - ID ê¸°ë°˜ìœ¼ë¡œ íŠ¹ì • ë©”ì‹œì§€ ì¶”ì 
5. **í™•ì¥ì„±** - ëŒ€ê·œëª¨ ë°ì´í„°ì— ì í•©

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜

### ê¸°ì¡´ ìºì‹œì—ì„œ ì¦ë¶„ ìºì‹±ìœ¼ë¡œ ì „í™˜
```bash
# 1. ê¸°ì¡´ ìºì‹œ ë°±ì—…
cp -r cache cache_backup

# 2. ìºì‹œ ì´ˆê¸°í™”
python -X utf8 test/test_embedding_workflow.py --use-cache --clear-cache

# 3. ì¦ë¶„ ìºì‹±ìœ¼ë¡œ ì¬ì‹¤í–‰
python -X utf8 test/test_embedding_workflow.py --use-cache --sample-size 50
```

ì¦ë¶„ ìºì‹±ì€ **ê¸°ë³¸ìœ¼ë¡œ í™œì„±í™”**ë˜ì–´ ìˆìœ¼ë©°, ë°ì´í„°ë¥¼ ì ì§„ì ìœ¼ë¡œ ì¶”ê°€í•˜ëŠ” ê²½ìš° í° ì„±ëŠ¥ í–¥ìƒì„ ì œê³µí•©ë‹ˆë‹¤!
